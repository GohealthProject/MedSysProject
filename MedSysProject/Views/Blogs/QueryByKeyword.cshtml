@model IEnumerable<MedSysProject.Models.Blog>

@{
    ViewData["Title"] = "關鍵字搜尋";
    Layout = "~/Views/Shared/_Layout_Blogs.cshtml";
}
<main id="main">
    <section>
        <div class="container">
            <div class="row">

                <div class="col-md-9">
                    <h3 class="category-title">搜尋結果共:@ViewBag.total 筆</h3>

                    @* ---------開始區塊-------- *@

                    @foreach (var item in Model)
                    {

                        <div class="d-md-flex post-entry-2 half">
                            <a href="~/Blogs/SinglePost?SingleBlogID=@item.BlogId" class="me-4 thumbnail">
                                <img src="/blogs/GetBlogImageByte/@item.BlogId" alt="" class="img-fluid" style="width:483px; height:263px;">
                            </a>
                            <div>
                                <div class="post-meta"><span class="date">@Html.DisplayFor(modelItem => item.ArticleClass.BlogCategory1)</span> <span class="mx-1">&bullet;</span> <span>@Html.DisplayFor(modelItem => item.CreatedAt)</span></div>
                                <h3><a href="~/Test/SinglePost?SingleBlogID=@item.BlogId">@Html.DisplayFor(modelItem => item.Title)</a></h3>
                                <p>
                                    @{
                                        string content = item.Content;
                                        string truncatedContent = content.Length > 50 ? content.Substring(0, 50) + "..." : content;

                                            <p>@truncatedContent</p>
                                    }
                                </p>
                                <div class="d-flex align-items-center author">
                                    <div class="photo"><img src="/blogs/GetEmpImageByte/@item.EmployeeId" alt="" class="img-fluid"></div>
                                    <div class="name">
                                        <h3 class="m-0 p-0">@Html.DisplayFor(modelItem => item.Employee.EmployeeName)</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                    }

                    @* ---------結束區塊-------- *@


                    @* -------換頁------- *@

                    <div class="text-start py-4">
                        <div class="custom-pagination">
                            @{
                                int previous = ViewBag.Page - 1;
                                int next = ViewBag.Page + 1;
                                int current = ViewBag.Page;

                                if (ViewBag.page == 1)
                                {
                                            <a href="~/blogs/QueryByKeyword?txtKeyword=@ViewBag.Key&page=@previous" class="btn prev disabled" hidden>上一頁</a>
                                }
                                else
                                {
                                            <a href="~/blogs/QueryByKeyword?txtKeyword=@ViewBag.Key&page=@previous" class="prev">上一頁</a>
                                }


                                for (int i = 1; i <= ViewBag.MaxPage; i++)
                                {
                                    if (i == current)
                                    {
                                                <a href="~/blogs/QueryByKeyword?txtKeyword=@ViewBag.Key&page=@i" class="active">@i</a>
                                    }
                                    else
                                    {
                                                <a href="~/blogs/QueryByKeyword?txtKeyword=@ViewBag.Key&page=@i">@i</a>
                                    }
                                }

                                if (ViewBag.page == ViewBag.MaxPage)
                                {
                                            <a href="~/blogs/QueryByKeyword?txtKeyword=@ViewBag.Key&page=@next" class="btn prev disabled" hidden>下一頁</a>
                                }
                                else
                                {
                                            <a href="~/blogs/QueryByKeyword?txtKeyword=@ViewBag.Key&page=@next" class="prev">下一頁</a>
                                }
                                
                            }
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <!-- ======= Sidebar ======= -->
                    <div class="aside-block">

                        <ul class="nav nav-pills custom-tab-nav mb-4" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="pills-popular-tab" data-bs-toggle="pill" data-bs-target="#pills-popular" type="button" role="tab" aria-controls="pills-popular" aria-selected="true" onclick="loadSidePopular()">最多觀看</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-latest-tab" data-bs-toggle="pill" data-bs-target="#pills-latest" type="button" role="tab" aria-controls="pills-latest" aria-selected="false" onclick="loadSideLatest()">最新貼文</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-latest-tab" data-bs-toggle="pill" data-bs-target="#pills-thisCat" type="button" role="tab" aria-controls="pills-latest" aria-selected="false" onclick="loadSideThisCat()">相關貼文</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-popular" role="tabpanel" aria-labelledby="pills-popular-tab">
                            </div>
                            <div class="tab-pane fade show active" id="pills-latest" role="tabpanel" aria-labelledby="pills-popular-tab">
                            </div>
                            <div class="tab-pane fade show active" id="pills-thisCat" role="tabpanel" aria-labelledby="pills-popular-tab">
                            </div>
                        </div>
                    </div>

                    

                    <div class="aside-block">
                        <h3 class="aside-title">文章類別</h3>
                        <ul class="aside-links list-unstyled">
                            <li><a href="@Url.Content("~/Blogs/SelectBlogCategory")?CategoryID=1"><i class="bi bi-chevron-right"></i> 活動快訊</a></li>
                            <li><a href="@Url.Content("~/Blogs/SelectBlogCategory")?CategoryID=2"><i class="bi bi-chevron-right"></i> 醫療新知</a></li>
                            <li><a href="@Url.Content("~/Blogs/SelectBlogCategory")?CategoryID=3"><i class="bi bi-chevron-right"></i> 名人分享會</a></li>
                            <li><a href="@Url.Content("~/Blogs/SelectBlogCategory")?CategoryID=4"><i class="bi bi-chevron-right"></i> 媒體報導</a></li>
                            <li><a href="@Url.Content("~/Blogs/SelectBlogCategory")?CategoryID=5"><i class="bi bi-chevron-right"></i> 企業責任</a></li>
                        </ul>
                    </div><!-- End Categories -->
                </div>

            </div>
        </div>
    </section>
</main>
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSidePopular();
        });
        async function loadSidePopular() {
            const response = await fetch(`https://localhost:7078/api/Blogs/popular6`);
            const data = await response.json();
            console.log(data);
            const popularContainer = document.querySelector('#pills-popular');
            const popular6 = data.$values.map(blog => {
                const { blogId, title, author, articleClass, createdAt,views } = blog;

                const date = new Date(createdAt);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                return ` <div class="post-entry-1 border-bottom">
                                                                 <div class="post-meta">
                                                                   <span class="date">${articleClass}</span>
                                                                    <span class="mx-1">&bullet;</span>
                                                                    <span>${formattedDate}</span>
                                                                </div>
                                                            <h2 class="mb-2"><a href="@Url.Content("~/Blogs/SinglePost")?SingleBlogID=${blogId}">${title}</a></h2>
                                                                       <span class="author mb-3 d-block">${author}&nbsp;&nbsp;瀏覽人次:${views}</span>
                                                           </div>

                                                        `
            })
            popularContainer.innerHTML = popular6.join('');
        }
        async function loadSideLatest() {
            const response = await fetch(`https://localhost:7078/api/Blogs/latest6`);
            const data = await response.json();
            //console.log(data);
            const latestContainer = document.querySelector('#pills-latest');

            const latest6 = data.$values.map(blog => {
                const { blogId, title, author, articleClass, createdAt ,views} = blog;

                const date = new Date(createdAt);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                return ` <div class="post-entry-1 border-bottom">
                                                                 <div class="post-meta">
                                                                   <span class="date">${articleClass}</span>
                                                                    <span class="mx-1">&bullet;</span>
                                                                    <span>${formattedDate}</span>
                                                                </div>
                                                            <h2 class="mb-2"><a href="@Url.Content("~/Blogs/SinglePost")?SingleBlogID=${blogId}">${title}</a></h2>
                                                                       <span class="author mb-3 d-block">${author}&nbsp;&nbsp;瀏覽人次:${views}</span>
                                                           </div>

                                                        `
            })
            latestContainer.innerHTML = latest6.join('');
        }
        async function loadSideThisCat() {
            let url = `https://localhost:7078/api/Blogs/thisCat6/${blogClassId}`;
            console.log(url);
            const response = await fetch(`https://localhost:7078/api/Blogs/thisCat6/?id=${blogClassId}`);
            const data = await response.json();
            console.log(data);
            const thisCarContainer = document.querySelector('#pills-thisCat');
            const thisCat6 = data.$values.map(blog => {
                const { blogId, title, author, articleClass, createdAt ,views} = blog;

                const date = new Date(createdAt);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                return ` <div class="post-entry-1 border-bottom">
                                                                 <div class="post-meta">
                                                                   <span class="date">${articleClass}</span>
                                                                    <span class="mx-1">&bullet;</span>
                                                                    <span>${formattedDate}</span>
                                                                </div>
                                                            <h2 class="mb-2"><a href="@Url.Content("~/Blogs/SinglePost")?SingleBlogID=${blogId}">${title}</a></h2>
                                                                       <span class="author mb-3 d-block">${author}&nbsp;&nbsp;瀏覽人次:${views}</span>
                                                           </div>

                                                        `
            })
            thisCarContainer.innerHTML = thisCat6.join('');
            //const thisCat6
        }
    </script>
}
