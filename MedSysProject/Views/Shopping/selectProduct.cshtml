@using System.Text.Json
@model CProductWarp
@{
    ViewData["Title"] = "selectProduct";
    Layout = "~/Views/Shared/_Layout_Shopping.cshtml";
    string s = Model.UnitPrice.ToString();
    
}
<section class="breadcrumbs">
    <div class="container">

        <div class="d-flex justify-content-between align-items-center">
            <h2>產品規格</h2>
            <ol>
                <li><a asp-action="index">主頁</a></li>
                <li><a asp-action="CatProduct" asp-route-id="@Model.Product.ProductsClassifications.FirstOrDefault().Categories.CategoriesId">@Model.Product.ProductsClassifications.FirstOrDefault().Categories.CategoriesName</a></li>
                <li>產品規格</li>
            </ol>
        </div>

    </div>
</section><!-- Breadcrumbs -->
<!-- ======= Portfolio Details Section ======= -->
<section id="portfolio-details" class="portfolio-details">
    <div class="container">

        <div class="row gy-4">

            <div class="col-lg-8">
                <div class="portfolio-details-slider swiper">
                    <div class="swiper-wrapper align-items-center">
                        @{
                            int count = 0;
                            foreach(var img in Model.Path)
                            {
                                                                                                                        <div class="swiper-slide">
                                                                                                                            <img src="@Url.Content("~/img-product/")@Model.Path[count]" alt="" style="height:856px;width:856px">
                                                                                                                        </div>
                                count++;
                            }
                        } 
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="portfolio-info">
                    <h3 class="fs-2">@Model.ProductName</h3>
                    <ul>
                        <li class="fs-4"><strong>分類</strong>: Web design</li>
                        <li class="fs-4"><strong>出貨商</strong>: ASU Company</li>
                        <li class="fs-4"><strong>產品價格</strong><span class="text-danger">    $@s.TrimEnd('0').TrimEnd('.')</span></li>
                        <li class="fs-4"><strong>證號</strong>: <a href="#">@Model.License</a></li>
                    </ul>
                </div>
                <div class="portfolio-description">
                    <h2>@Model.License</h2>
                    <p class="fs-3 scrollable-content" style="max-height: 400px; overflow-y: auto;">
                        @Model.Description
                    </p>
                    
                    <p>
                        <form  id="datas">
                            <select name="count" class="form-select" style="display:inline ; width:200px" >
                                @{
                                    for(int i = 1; i <= Model.UnitsInStock; i++)
                                    {
                                                                                                                                <option value="@i">@i</option>
                                        if (i >= 50)
                                        {
                                                                                                                                    <option>...</option>
                                            break;
                                        }
                                    }
                                }
                                }
                        </select>
                        <input type="hidden" value="@Model.ProductId" name="id" />
                            @{
                                if (!Context.Session.Keys.Contains(CDictionary.SK_MEMBER_LOGIN))
                                {
                                                                                                            <img src="~/img/Noheart.png" id="ProductTracking" />
                                }
                                else
                                {
                                string json = Context.Session.GetString(CDictionary.SK_MEMBER_LOGIN);
                                MemberWarp member = JsonSerializer.Deserialize<MemberWarp>(json);
                                var q = Model.Product.TrackingLists.Where(n => n.ProductId == Model.ProductId && n.MemberId == member.MemberId);
                                if (!q.Any())
                                {
                                                                                                            <img src="~/img/Noheart.png" id="ProductTracking" />
                                }
                                else
                                {
                                                                                                            <img src="~/img/heart.png" id="ProductTracking" />
                                }
                                }
                                
                            }                 
                        <button class="btn btn-info" onclick="addToCart(event)">加入購物車</button>
                        </form>
                    </p>
                </div>
            </div>

        </div>

    </div>
</section><!-- End Portfolio Details Section -->
<div class="container">
<div style="height:430px;width:100%;" class=" mt-3 ">
    <div style="height:400px" class="">
        <div style="height:100px" class=" d-flex align-items-center ">
            <span class="fs-1 ps-4">你可能對這個有興趣</span>
        </div>
        <div style="height:350px">
            <div class="row ps-3">
                        <div class="col p-3  ">
                            <img src="~/img/Login1.jpg" style="height:150px; width:200px;"><br />
                            <a href="" class="fs-3"> 產品A </a><br />
                            <span class="fs-3 text-danger">$500</span>
                        </div>
                        <div class="col p-3  ">
                            <img src="~/img/Login1.jpg" style="height:150px; width:200px;"><br />
                            <a href="" class="fs-3"> 產品A </a><br />
                            <span class="fs-3 text-danger">$500</span>
                        </div>
                        <div class="col p-3  ">
                            <img src="~/img/Login1.jpg" style="height:150px; width:200px;"><br />
                            <a href="" class="fs-3"> 產品A </a><br />
                            <span class="fs-3 text-danger">$500</span>
                        </div>
                    <div class="col p-3  ">
                        <img src="~/img/Login1.jpg" style="height:150px; width:200px;"><br />
                        <a href="" class="fs-3"> 產品A </a><br />
                        <span class="fs-3 text-danger">$500</span>
                    </div>
                    <div class="col p-3  ">
                        <img src="~/img/Login1.jpg" style="height:150px; width:200px;"><br />
                        <a href="" class="fs-3"> 產品A </a><br />
                        <span class="fs-3 text-danger">$500</span>
                    </div>
            </div>
        </div>

    </div>
</div>
</div>
<div class="container mb-3" >
    
</div>
<div class="container bg-white" id="reviewList" >
    <div class="fs-2 mb-5">商品評價:</div>
</div>
@section Scripts{
    <script>
        const reviewList = document.querySelector("#reviewList");
        const item = document.querySelector("#datas");
        const Pid = @Model.ProductId;
        let count = 0;
        @{
            int memberid = 0;
            string memberImage = "";
            if (Context.Session.Keys.Contains(CDictionary.SK_MEMBER_LOGIN))
            {
                string json = Context.Session.GetString(CDictionary.SK_MEMBER_LOGIN);
                MemberWarp member = JsonSerializer.Deserialize<MemberWarp>(json);
                memberid = member.MemberId;
                memberImage = member.MemberImage;
            }
            else
            {
                
            }
        }
        const Mid= @memberid;
        let reviewInput = "";
        console.log(`產品ID${Pid}會員ID${Mid}`);
        var data = new FormData(item);
        let heart = document.querySelector("#ProductTracking");
        heart.addEventListener("click", ProductTracking);
        async function addToCart(event){
            event.preventDefault()
            var data = new FormData(item);
            const response = await fetch("@Url.Content("~/Shopping/AddToCart")",{
                body: data,
                method:"POST",
            })
            const re = await response.text();
            getcartList()
            alert("加入購物車成功");
        }
        async function ProductTracking(event){
            event.preventDefault()
            let imgPath = event.target.src;
            let img = imgPath.lastIndexOf("/");
            let imgName = imgPath.substring(img + 1);

            if (imgName === "Noheart.png") {
                let url = `@Url.Content("/Shopping/ProductTracking?")Pid=${id}&heart=${imgName}`
                const response = await fetch(url)
                const data = await response.text();
                console.log(data);
                if(data === "請先登入"){
                    alert(data);
                    return;
                }
                event.target.src= "/img/heart.png";
                alert(data);
            } else if(imgName === "heart.png") {
                let url = `@Url.Content("/Shopping/ProductTracking?")Pid=${id}&heart=${imgName}`
                const response = await fetch(url)
                const data = await response.text();
                console.log(data);
                if(data === "請先登入"){
                    alert(data);
                    return;
                }
                event.target.src = "/img/Noheart.png";
                alert(data);
            }
        }
        function changeImg(imgElement) {
            $("#imgList>img").css("border", "");
            const src = imgElement.src;
            document.querySelector("#mainImg").src = src;
            imgElement.style.border = "1px dashed red";
        }
        document.addEventListener("DOMContentLoaded", () => {
            reviewSearch();
            document.addEventListener("keydown", process);
            document.addEventListener("input", updateInput);
        })
        function updateInput() {
            reviewInput=document.querySelector("#review").value;
        }

        async function process(event){
            review(event)
        }
        async function reviewSearch() {
            count = 0;
            const url = `https://localhost:7078/api/ProductReviews/pid=${Pid}`
            const response = await fetch(url);
            const data = await response.json();
            console.log("檔案長度" +data.length);
            if (data.length != 0) {
                const value = data.map(reviewItem => {
                    count++;
                    const content = reviewItem.reviewContent;
                    const member = reviewItem.member.memberImage;
                    const memberid = reviewItem.memberId;
                    const memberNickname = reviewItem.member.memberNickname;
                    let feedback = "";
                    if (reviewItem.isLike) {
                        feedback = "good.png";
                    } else {
                        feedback = "nogood-review.png";
                    }
                    const date = reviewItem.timestamp;
                    var dataobj = new Date(date);
                    const year = dataobj.getFullYear();
                    const month = dataobj.getMonth() + 1;
                    const day = dataobj.getDate();
                    
                    let html =
                        `
                                <div class="row mb-3 p-3" >
                                    <div class="col-1">
                                    <img src="/img/MemberImg/${member}" style="height:80px;width:80px;margin-right:10px" onclick=""/>
                                    </div>
                                    <div class="col-11">
                                    <span  id="inputGroup-sizing-lg">${memberNickname}<img src="/img/icon/${feedback}" style="display:inline;"/><br>${year}-${month}-${day}<br></span>
                                    <span class="fs-3">${content}</span>
                                    <input type="hidden"  id="memberID" value="${memberid}"/>
                                    </div>
                                    <hr class="mt-3">
                                </div>
                        `
                    return html;
                })
                reviewList.innerHTML = "";
                reviewList.innerHTML += value.join("");
                if (Mid == 0) {
                    return;
                }
                if (count  == data.length) {
                    reviewList.innerHTML +=
                        `
                                            <span class="input-group-text" id="inputGroup-sizing-lg"><img src="@Url.Content("~/img/MemberImg/")@memberImage" style="height:80px;width:80px" /><input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-lg" placeholder="輸入留言" id="review"></span>
                        `
                }
            } else {
                reviewList.innerHTML +=
                    `
                                                     <span class="input-group-text" id="inputGroup-sizing-lg"><img src="@Url.Content("~/img/MemberImg/")@memberImage" style="height:80px;width:80px" /><input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-lg" placeholder="輸入留言" id="review"></span>
                   `
            }
            
            
        }
        async function review(event) {
            if(event.key=="Enter"){
                if (reviewInput == "") {
                    return;
                }else {
                    const url = `https://localhost:7078/api/ProductReviews/mid=${Mid}&pid=${Pid}`
                    console.log(url);
                    console.log(JSON.stringify(reviewInput));
                    let form = new FormData();
                    form.append("review", reviewInput);
                    const response = await fetch(url, {
                        method:"POST",
                        body: form,
                    })
                    const data = await response.text();
                    console.log(data)
                    reviewSearch();
                    return;
                }
            }
            
        }
    </script>
}